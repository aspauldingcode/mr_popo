name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-and-test:
    name: Build & Lint with Nix
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Cache Nix Store
        uses: cachix/cachix-action@v14
        with:
          name: cache-name # Replace if you use cachix
          skipPush: true # Omit or set false if authenticated

      - name: Install Dependencies & Run Linters
        run: |
          nix develop --command bash -c "npm ci && npm run lint && npm run format:check"

  deploy:
    name: Deploy to Replit
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: Trigger Replit Deployment
        # NOTE: This is a placeholder since Replit does not have a native deployment GitHub Action without configuration.
        # Typically you connect your GitHub repo to Replit, and it pulls on commits automatically.
        # Alternatively, you can use a webhook if Replit/Railway exposes one:
        run: |
          echo "Triggering deployment..."
          # curl -X POST ${{ secrets.DEPLOY_WEBHOOK_URL }}
          echo "Deployment triggered successfully."
